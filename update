#!/usr/bin/env nix-shell
#! nix-shell -p curl jq -i bash
# shellcheck shell=bash
set -euo pipefail

ATLAS_UPDATE_SRV="${ATLAS_UPDATE_SRV:-https://atlasbinaries.com/atlas}"
ATLAS_UPDATE_SRV_FALLBACK="${ATLAS_UPDATE_SRV_FALLBACK:-https://release.ariga.io/atlas}"

TMP_DIR=$(mktemp -d)
trap 'rm -rf "$TMP_DIR"' EXIT

# Pick the platform string used by Atlas installers and download "latest" to discover current version.
PLATFORM_HOST="linux-amd64"
case "$(uname -s)-$(uname -m)" in
  Linux-x86_64) PLATFORM_HOST="linux-amd64" ;;
  Darwin-x86_64|Darwin-x86-64|Darwin-amd64) PLATFORM_HOST="darwin-amd64" ;;
  Darwin-arm64|Darwin-aarch64|Darwin-armv8l) PLATFORM_HOST="darwin-arm64" ;;
  *)
    echo "Error: Unsupported host platform '$(uname -s)-$(uname -m)'"
    exit 1
    ;;
esac

echo "Discovering latest Atlas version via Atlas installer stream..."
tmp_latest_bin="$TMP_DIR/atlas-$PLATFORM_HOST-latest"
latest_downloaded=false
for server in "$ATLAS_UPDATE_SRV" "$ATLAS_UPDATE_SRV_FALLBACK"; do
  if [[ -z "$server" ]]; then
    continue
  fi
  if curl -fsSL -o "$tmp_latest_bin" "$server/atlas-$PLATFORM_HOST-latest"; then
    latest_downloaded=true
    break
  fi
done

if [[ "$latest_downloaded" != true ]]; then
  echo "Error: Failed to download atlas-$PLATFORM_HOST-latest"
  exit 1
fi
chmod +x "$tmp_latest_bin"

VERSION=$("$tmp_latest_bin" version | awk '/^atlas version / {print $3}')
if [[ -z "$VERSION" ]]; then
  echo "Error: Could not determine Atlas version"
  exit 1
fi

VERSION="${VERSION#v}"
echo "Latest version: $VERSION"

# Check current version
CURRENT_VERSION=$(jq -r '.version' sources.json)
if [[ "$CURRENT_VERSION" == "$VERSION" ]]; then
  echo "Already up to date (v$VERSION)"
  exit 0
fi

echo "Updating from v$CURRENT_VERSION to v$VERSION"

# Platform mappings: nix system -> atlas binary name
declare -A PLATFORMS=(
  ["x86_64-linux"]="linux-amd64"
  ["x86_64-darwin"]="darwin-amd64"
  ["aarch64-darwin"]="darwin-arm64"
)

# Fetch SHA256 hashes for each platform
for system in "${!PLATFORMS[@]}"; do
  binary_name="${PLATFORMS[$system]}"
  for server in "$ATLAS_UPDATE_SRV" "$ATLAS_UPDATE_SRV_FALLBACK"; do
    if [[ -z "$server" ]]; then
      continue
    fi
    url="$server/atlas-${binary_name}-v${VERSION}"
    sha256=$(nix-prefetch-url "$url" 2>/dev/null)
    if [[ -n "$sha256" ]]; then
      break
    fi
    sha256=""
  done

  echo "Fetching hash for $system..."

  if [[ -z "$sha256" ]]; then
    echo "Error: Failed to fetch $url"
    exit 1
  fi

  echo "  $system: $sha256"

  # Store platform data
  jq -n \
    --arg url "$url" \
    --arg sha256 "$sha256" \
    '{"url": $url, "sha256": $sha256}' > "$TMP_DIR/$system.json"
done

# Build new sources.json
echo "Writing sources.json..."
jq -n \
  --arg version "$VERSION" \
  --argjson x86_64_linux "$(cat "$TMP_DIR/x86_64-linux.json")" \
  --argjson x86_64_darwin "$(cat "$TMP_DIR/x86_64-darwin.json")" \
  --argjson aarch64_darwin "$(cat "$TMP_DIR/aarch64-darwin.json")" \
  '{
    "version": $version,
    "platforms": {
      "x86_64-linux": $x86_64_linux,
      "x86_64-darwin": $x86_64_darwin,
      "aarch64-darwin": $aarch64_darwin
    }
  }' > sources.json

echo "Updated to v$VERSION"
